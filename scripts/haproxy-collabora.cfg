# Sample HAProxy configuration for Collabora Online cluster with sticky sessions
# Assumes Collabora nodes listen on port 9980 (HTTP)

global
  log stdout format raw local0
  maxconn 20000

defaults
  log     global
  mode    http
  option  httplog
  option  dontlognull
  option  http-keep-alive
  timeout connect 30s
  timeout client  3600s
  timeout server  3600s
  timeout tunnel  3600s

frontend fe_collabora
  bind *:9980
  # Serve missing Collabora icon with a tiny placeholder to avoid noisy 404s
  acl collabora_svg path_reg ^/browser/.*/images/lc_nobreak\.svg$
  http-request return status 200 content-type image/svg+xml lf-string "<svg xmlns='http://www.w3.org/2000/svg' width='1' height='1'/>" if collabora_svg
  default_backend be_collabora

backend be_collabora
  balance uri whole
  cookie SRV insert indirect nocache
  # Sticky by WOPISrc so a document session stays on one node
  stick-table type string len 256 size 1m expire 60m
  stick on urlp(WOPISrc)

  # Discover scaled containers by Docker DNS
  # When scaling: docker compose up -d --scale collabora=5
  # Docker will register tasks as collabora, collabora_1, collabora_2, ... on the same network
  server-template collabora 10 collabora:9980 check inter 2s rise 3 fall 2 resolvers docker init-addr libc,none

resolvers docker
  nameserver dns 127.0.0.11:53
